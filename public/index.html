<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>CHC Paint - Warehouse Sale</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    .line-through { text-decoration: line-through; }
    .scrollbar-hide::-webkit-scrollbar { display: none; }
    .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(-10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .fade-in { animation: fadeIn 0.3s ease-out; }
    @keyframes shake {
      0%, 100% { transform: translateX(0); }
      25% { transform: translateX(-5px); }
      75% { transform: translateX(5px); }
    }
    .shake { animation: shake 0.3s ease-in-out; }
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    .animate-spin { animation: spin 1s linear infinite; }
  </style>
</head>
<body class="bg-gray-50">
  <div id="app"></div>

  <script>
    // ========================================
    // CONFIGURATION
    // ========================================
    const BRANCH_EMAILS = {
      "Woodbridge": "woodbridge@chcpaint.com",
      "Markham": "markham@chcpaint.com",
      "Ottawa": "ottawa@chcpaint.com",
      "Hamilton": "hamilton@chcpaint.com",
      "Oakville": "oakville@chcpaint.com",
      "St. Catharines": "stcatharines@chcpaint.com"
    };

    const BRANCHES = ["Woodbridge", "Markham", "Ottawa", "Hamilton", "Oakville", "St. Catharines"];

    // ========================================
    // DYNAMIC DATA (loaded from API)
    // ========================================
    let PRODUCTS = {};
    let BRANDS = [];
    let PRODUCT_COUNTS = {};
    let TOTAL_PRODUCTS = 0;

    // ========================================
    // APPLICATION STATE
    // ========================================
    let state = {
      // Sale selection
      screen: 'loading', // loading | sale-picker | login | catalog | order-success
      activeSales: [],
      selectedSale: null,
      isLoadingSales: true,
      isLoadingProducts: false,

      // Auth
      isAuthenticated: false,
      isAuthenticating: false,
      passwordError: false,
      authErrorMessage: "",

      // Catalog
      activeBrand: null,
      activeCategory: null,
      searchQuery: "",

      // Cart & Checkout
      cart: [],
      isCartOpen: false,
      isCheckoutOpen: false,
      orderSubmitted: false,
      isSubmitting: false,
      shopName: "",
      contactEmail: "",
      branch: "",
      toast: null,
      lastOrderId: null,
      orderNotes: ""
    };

    // ========================================
    // INIT — Load active sales
    // ========================================
    async function initApp() {
      // Check if already authenticated for a sale
      const savedSaleId = sessionStorage.getItem('chc_sale_id');
      const savedAuth = sessionStorage.getItem('chc_authenticated');

      try {
        const res = await fetch('/api/sales');
        const sales = await res.json();

        if (Array.isArray(sales) && sales.length > 0) {
          state.activeSales = sales;

          // If only one active sale, skip the picker
          if (sales.length === 1) {
            state.selectedSale = sales[0];

            if (savedAuth === 'true' && savedSaleId === sales[0].id) {
              // Already authenticated
              state.isAuthenticated = true;
              state.screen = 'catalog';
              await loadProductsForSale(sales[0].id);
            } else {
              state.screen = 'login';
            }
          } else if (savedAuth === 'true' && savedSaleId) {
            // Returning user — find their sale
            const sale = sales.find(s => s.id === savedSaleId);
            if (sale) {
              state.selectedSale = sale;
              state.isAuthenticated = true;
              state.screen = 'catalog';
              await loadProductsForSale(sale.id);
            } else {
              state.screen = 'sale-picker';
            }
          } else {
            state.screen = 'sale-picker';
          }
        } else {
          // No active sales — show a message or try legacy mode
          state.activeSales = [];
          state.screen = 'login'; // Legacy: single password
        }
      } catch (e) {
        console.error('Failed to load sales:', e);
        // Fallback: show login for legacy mode
        state.screen = 'login';
      }

      state.isLoadingSales = false;
      render();
    }

    async function loadProductsForSale(saleId) {
      state.isLoadingProducts = true;
      render();

      try {
        const res = await fetch(`/api/sales/${saleId}/products`);
        const data = await res.json();

        PRODUCTS = data.products || {};
        BRANDS = data.brands || Object.keys(PRODUCTS);
        PRODUCT_COUNTS = data.productCounts || {};
        TOTAL_PRODUCTS = data.total || 0;

        state.activeBrand = BRANDS.length > 0 ? BRANDS[0] : null;
      } catch (e) {
        console.error('Failed to load products:', e);
        PRODUCTS = {};
        BRANDS = [];
        PRODUCT_COUNTS = {};
        TOTAL_PRODUCTS = 0;
      }

      state.isLoadingProducts = false;
    }

    // ========================================
    // SALE SELECTION
    // ========================================
    function selectSale(saleId) {
      const sale = state.activeSales.find(s => s.id === saleId);
      if (sale) {
        state.selectedSale = sale;
        state.screen = 'login';
        state.passwordError = false;
        state.authErrorMessage = '';
        render();
      }
    }

    function backToSalePicker() {
      state.selectedSale = null;
      state.isAuthenticated = false;
      state.screen = 'sale-picker';
      sessionStorage.removeItem('chc_authenticated');
      sessionStorage.removeItem('chc_sale_id');
      render();
    }

    // ========================================
    // PASSWORD CHECK (server-side)
    // ========================================
    async function checkPassword() {
      const input = document.getElementById('passwordInput');
      const password = input ? input.value : '';

      if (!password) {
        state.passwordError = true;
        state.authErrorMessage = 'Please enter a password.';
        render();
        return;
      }

      state.isAuthenticating = true;
      state.passwordError = false;
      state.authErrorMessage = '';
      render();

      try {
        const body = { password };
        if (state.selectedSale) {
          body.sale_id = state.selectedSale.id;
        }

        const response = await fetch('/api/auth/verify', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(body)
        });

        const result = await response.json();

        if (response.ok && result.success) {
          state.isAuthenticated = true;
          state.passwordError = false;
          state.isAuthenticating = false;

          sessionStorage.setItem('chc_authenticated', 'true');
          if (state.selectedSale) {
            sessionStorage.setItem('chc_sale_id', state.selectedSale.id);
          }

          // Load products
          if (state.selectedSale) {
            state.screen = 'catalog';
            render();
            await loadProductsForSale(state.selectedSale.id);
            render();
          } else {
            state.screen = 'catalog';
            render();
          }
        } else {
          state.passwordError = true;
          state.isAuthenticating = false;
          state.authErrorMessage = result.error || 'Incorrect password. Please try again.';
          render();
          setTimeout(() => {
            const form = document.getElementById('loginForm');
            if (form) form.classList.add('shake');
          }, 10);
        }
      } catch (error) {
        console.error('Auth error:', error);
        state.passwordError = true;
        state.isAuthenticating = false;
        state.authErrorMessage = 'Connection error. Please try again.';
        render();
      }
    }

    function handlePasswordKeypress(e) {
      if (e.key === 'Enter') checkPassword();
    }

    // ========================================
    // UTILITY FUNCTIONS
    // ========================================
    function formatPrice(price) {
      return parseFloat(price).toFixed(2);
    }

    function getDiscount(prev, sale) {
      const p = parseFloat(prev);
      const s = parseFloat(sale);
      if (p <= 0) return 0;
      return Math.round((p - s) / p * 100);
    }

    function getCartTotal() {
      return state.cart.reduce((sum, item) => sum + parseFloat(item.salePrice) * item.quantity, 0);
    }

    function getCartCount() {
      return state.cart.reduce((sum, item) => sum + item.quantity, 0);
    }

    function getFilteredProducts() {
      const brandData = PRODUCTS[state.activeBrand];
      if (!brandData) return { hasCategories: false, products: [] };

      const q = state.searchQuery.toLowerCase();

      if (brandData.hasCategories) {
        const filteredCategories = {};
        Object.entries(brandData.categories).forEach(([category, products]) => {
          const filtered = q
            ? products.filter(p => p.sku.toLowerCase().includes(q) || p.name.toLowerCase().includes(q))
            : products;
          if (filtered.length > 0) {
            filteredCategories[category] = filtered;
          }
        });
        return { hasCategories: true, categories: filteredCategories };
      } else {
        const products = brandData.products || [];
        const filtered = q
          ? products.filter(p => p.sku.toLowerCase().includes(q) || p.name.toLowerCase().includes(q))
          : products;
        return { hasCategories: false, products: filtered };
      }
    }

    function getTotalFilteredCount() {
      const data = getFilteredProducts();
      if (data.hasCategories) {
        let count = 0;
        Object.values(data.categories).forEach(products => count += products.length);
        return count;
      }
      return data.products.length;
    }

    // ========================================
    // CART & UI ACTIONS
    // ========================================
    function setBrand(brand) {
      state.activeBrand = brand;
      state.activeCategory = null;
      state.searchQuery = "";
      render();
    }

    function setSearch(query) {
      state.searchQuery = query;
      render();
    }

    // ========================================
    // PROMO RULES (applied client-side)
    // ========================================
    const PROMO_RULES = {
      "MMM01131": { type: "per_case", pay: 3, get: 4, message: "Buy 3 Gallons Get 1 Gallon free" },
      "SEM39694": { type: "per_case", pay: 5, get: 6, message: "Buy 5 Get 1 Free" },
      "SEM40494": { type: "per_case", pay: 5, get: 6, message: "Buy 5 Get 1 Free" },
      "SEM40504": { type: "per_case", pay: 5, get: 6, message: "Buy 5 Get 1 Free" },
      "SEM39774": { type: "per_case", pay: 5, get: 6, message: "Buy 5 Get 1 Free" },
      "SEM40434": { type: "per_case", pay: 5, get: 6, message: "Buy 5 Get 1 Free" }
    };

    function getCaseQty(product) {
      return product.caseQty || 1;
    }

    function getPromoInfo(sku, quantity) {
      const rule = PROMO_RULES[sku];
      if (!rule) return null;

      if (rule.type === 'per_case') {
        const cases = Math.floor(quantity / rule.get);
        const freeUnits = cases;
        return {
          type: 'per_case',
          message: rule.message,
          freeUnits,
          effectiveQty: quantity - freeUnits,
          pay: rule.pay,
          get: rule.get
        };
      }
      return null;
    }

    function addToCart(product) {
      const caseQty = getCaseQty(product);
      const existing = state.cart.find(item => item.sku === product.sku);
      if (existing) {
        existing.quantity += caseQty;
      } else {
        state.cart.push({ ...product, quantity: caseQty });
      }
      showToast(`Added ${caseQty} x ${product.sku} to cart`);
      render();
    }

    function updateQuantity(sku, delta) {
      const item = state.cart.find(i => i.sku === sku);
      if (item) {
        const caseQty = getCaseQty(item);
        const newQty = item.quantity + (delta * caseQty);
        if (newQty < caseQty) {
          state.cart = state.cart.filter(i => i.sku !== sku);
        } else {
          item.quantity = newQty;
        }
      }
      render();
    }

    function removeFromCart(sku) {
      state.cart = state.cart.filter(i => i.sku !== sku);
      render();
    }

    function openCart() { state.isCartOpen = true; render(); }
    function closeCart() { state.isCartOpen = false; render(); }
    function openCheckout() { state.isCheckoutOpen = true; render(); }
    function closeCheckout() { state.isCheckoutOpen = false; render(); }

    function scrollToCategory(categoryId) {
      const element = document.getElementById(categoryId);
      if (element) element.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }

    // ========================================
    // ORDER SUBMISSION
    // ========================================
    async function submitOrder() {
      if (!state.shopName || !state.contactEmail || !state.branch) {
        showToast("Please fill in all fields");
        return;
      }

      state.isSubmitting = true;
      render();

      try {
        const body = {
          shopName: state.shopName,
          email: state.contactEmail,
          branch: state.branch,
          items: state.cart.map(item => ({
            ...item,
            caseQty: getCaseQty(item),
            promoMessage: PROMO_RULES[item.sku]?.message || null
          })),
          total: getCartTotal(),
          orderNotes: state.orderNotes || ''
        };

        if (state.selectedSale) {
          body.sale_id = state.selectedSale.id;
        }

        const response = await fetch('/api/orders', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(body)
        });

        if (!response.ok) {
          const errorData = await response.json();
          throw new Error(errorData.error || 'Failed to submit order');
        }

        const result = await response.json();
        state.lastOrderId = result.orderId;
        state.isSubmitting = false;
        state.screen = 'order-success';
        state.isCartOpen = false;
        state.isCheckoutOpen = false;
        render();
      } catch (error) {
        state.isSubmitting = false;
        showToast(error.message || "Failed to submit order. Please try again.");
        render();
      }
    }

    function resetOrder() {
      state.screen = 'catalog';
      state.cart = [];
      state.shopName = "";
      state.contactEmail = "";
      state.branch = "";
      state.orderNotes = "";
      state.lastOrderId = null;
      render();
    }

    function showToast(message) {
      state.toast = message;
      render();
      setTimeout(() => { state.toast = null; render(); }, 2500);
    }

    function handleSubmitOrder() {
      state.shopName = document.getElementById('shopNameInput')?.value || '';
      state.contactEmail = document.getElementById('emailInput')?.value || '';
      state.branch = document.getElementById('branchSelect')?.value || '';
      state.orderNotes = document.getElementById('orderNotesInput')?.value || '';
      submitOrder();
    }

    // ========================================
    // RENDER
    // ========================================
    function render() {
      const app = document.getElementById('app');

      switch (state.screen) {
        case 'loading':
          app.innerHTML = renderLoadingScreen();
          break;
        case 'sale-picker':
          app.innerHTML = renderSalePicker();
          break;
        case 'login':
          app.innerHTML = renderLoginPage();
          setTimeout(() => {
            const input = document.getElementById('passwordInput');
            if (input) input.focus();
          }, 100);
          break;
        case 'catalog':
          if (state.isLoadingProducts) {
            app.innerHTML = renderLoadingScreen();
          } else {
            app.innerHTML = `
              ${renderHeader()}
              ${renderMain()}
              ${state.isCartOpen ? renderCartSidebar() : ''}
              ${state.isCheckoutOpen ? renderCheckoutModal() : ''}
              ${state.toast ? renderToast() : ''}
            `;
            attachEventListeners();
          }
          break;
        case 'order-success':
          app.innerHTML = renderOrderSuccess();
          break;
        default:
          app.innerHTML = renderLoadingScreen();
      }
    }

    function renderLoadingScreen() {
      return `
        <div class="min-h-screen bg-gradient-to-br from-slate-900 via-slate-800 to-slate-900 flex items-center justify-center">
          <div class="text-center">
            <div class="inline-flex items-center justify-center w-20 h-20 bg-orange-500 rounded-2xl shadow-lg mb-6">
              <i class="fas fa-box text-white text-3xl"></i>
            </div>
            <h1 class="text-2xl font-bold text-white mb-4">CHC Paint</h1>
            <div class="flex items-center gap-2 text-slate-400">
              <i class="fas fa-spinner animate-spin"></i>
              <span>Loading…</span>
            </div>
          </div>
        </div>
      `;
    }

    // ========================================
    // SALE PICKER
    // ========================================
    function renderSalePicker() {
      return `
        <div class="min-h-screen bg-gradient-to-br from-slate-900 via-slate-800 to-slate-900 flex items-center justify-center p-4">
          <div class="w-full max-w-lg">
            <div class="text-center mb-8">
              <div class="inline-flex items-center justify-center w-20 h-20 bg-orange-500 rounded-2xl shadow-lg mb-6">
                <i class="fas fa-box text-white text-3xl"></i>
              </div>
              <h1 class="text-3xl font-bold text-white mb-2">CHC Paint</h1>
              <p class="text-slate-400">Select a sale to browse</p>
            </div>

            <div class="space-y-3">
              ${state.activeSales.map(sale => `
                <button onclick="selectSale('${sale.id}')"
                  class="w-full bg-white/10 hover:bg-white/15 backdrop-blur border border-white/10 rounded-xl p-5 text-left transition-all group">
                  <div class="flex items-center justify-between">
                    <div>
                      <h3 class="text-lg font-bold text-white group-hover:text-orange-400 transition-colors">${escHtml(sale.name)}</h3>
                      ${sale.description ? `<p class="text-slate-400 text-sm mt-1">${escHtml(sale.description)}</p>` : ''}
                      ${sale.end_date ? `<p class="text-slate-500 text-xs mt-2"><i class="fas fa-calendar mr-1"></i>Ends ${new Date(sale.end_date).toLocaleDateString()}</p>` : ''}
                    </div>
                    <i class="fas fa-arrow-right text-slate-500 group-hover:text-orange-400 transition-colors"></i>
                  </div>
                </button>
              `).join('')}
            </div>

            ${state.activeSales.length === 0 ? `
              <div class="text-center py-12">
                <i class="fas fa-store-slash text-4xl text-slate-600 mb-4"></i>
                <h3 class="text-white text-lg font-semibold mb-2">No Active Sales</h3>
                <p class="text-slate-400">There are no sales running right now. Check back later!</p>
              </div>
            ` : ''}
          </div>
        </div>
      `;
    }

    // ========================================
    // LOGIN PAGE
    // ========================================
    function renderLoginPage() {
      const saleName = state.selectedSale ? state.selectedSale.name : 'Warehouse Sale';
      const showBack = state.activeSales.length > 1;

      return `
        <div class="min-h-screen bg-gradient-to-br from-slate-900 via-slate-800 to-slate-900 flex items-center justify-center p-4">
          <div class="w-full max-w-md">
            <div class="text-center mb-8">
              <div class="inline-flex items-center justify-center w-20 h-20 bg-orange-500 rounded-2xl shadow-lg mb-6">
                <i class="fas fa-box text-white text-3xl"></i>
              </div>
              <h1 class="text-3xl font-bold text-white mb-2">CHC Paint</h1>
              <p class="text-slate-400">${escHtml(saleName)}</p>
            </div>

            <div id="loginForm" class="bg-white rounded-2xl shadow-2xl p-8 ${state.passwordError ? 'shake' : ''}">
              <div class="text-center mb-6">
                <div class="inline-flex items-center justify-center w-12 h-12 bg-slate-100 rounded-full mb-4">
                  <i class="fas fa-lock text-slate-600 text-xl"></i>
                </div>
                <h2 class="text-xl font-bold text-slate-900">Customer Access</h2>
                <p class="text-slate-500 text-sm mt-1">Enter your password to view the catalog</p>
              </div>

              <div class="space-y-4">
                <div>
                  <label class="block text-sm font-medium text-slate-700 mb-2">Password</label>
                  <div class="relative">
                    <input
                      type="password"
                      id="passwordInput"
                      placeholder="Enter customer password"
                      onkeypress="handlePasswordKeypress(event)"
                      class="w-full px-4 py-3 border ${state.passwordError ? 'border-red-300 bg-red-50' : 'border-slate-200'} rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-transparent outline-none transition-colors"
                    >
                    <i class="fas fa-key absolute right-4 top-1/2 -translate-y-1/2 text-slate-400"></i>
                  </div>
                  ${state.passwordError ? `
                    <p class="mt-2 text-sm text-red-600 flex items-center gap-1">
                      <i class="fas fa-exclamation-circle"></i>
                      ${state.authErrorMessage || 'Incorrect password. Please try again.'}
                    </p>
                  ` : ''}
                </div>

                <button
                  onclick="checkPassword()"
                  class="w-full bg-orange-500 hover:bg-orange-600 text-white py-3 rounded-lg font-semibold transition-colors flex items-center justify-center gap-2"
                  ${state.isAuthenticating ? 'disabled' : ''}
                >
                  ${state.isAuthenticating ? `
                    <i class="fas fa-spinner animate-spin"></i>
                    <span>Verifying...</span>
                  ` : `
                    <span>Access Catalog</span>
                    <i class="fas fa-arrow-right"></i>
                  `}
                </button>

                ${showBack ? `
                  <button onclick="backToSalePicker()" class="w-full py-2 text-slate-500 hover:text-slate-700 text-sm font-medium transition-colors">
                    <i class="fas fa-arrow-left mr-1"></i> Choose a different sale
                  </button>
                ` : ''}
              </div>
            </div>

            <div class="text-center mt-6">
              <p class="text-slate-500 text-sm">
                <i class="fas fa-info-circle mr-1"></i>
                Contact your CHC sales rep if you need access
              </p>
            </div>
          </div>
        </div>
      `;
    }

    // ========================================
    // CATALOG HEADER
    // ========================================
    function renderHeader() {
      const saleName = state.selectedSale ? state.selectedSale.name : 'Warehouse Sale';
      return `
        <header class="bg-slate-900 text-white sticky top-0 z-40">
          <div class="max-w-7xl mx-auto px-4 py-4">
            <div class="flex items-center justify-between">
              <div class="flex items-center gap-3">
                <div class="w-10 h-10 bg-orange-500 rounded-lg flex items-center justify-center">
                  <i class="fas fa-box text-white"></i>
                </div>
                <div>
                  <h1 class="text-xl font-bold">CHC Paint</h1>
                  <p class="text-xs text-slate-400">${escHtml(saleName)} &bull; ${TOTAL_PRODUCTS} Products</p>
                </div>
              </div>
              <div class="flex items-center gap-2">
                ${state.activeSales.length > 1 ? `
                  <button onclick="backToSalePicker()" class="text-slate-400 hover:text-white px-3 py-2 rounded-lg text-sm transition-colors" title="Switch sale">
                    <i class="fas fa-exchange-alt"></i>
                  </button>
                ` : ''}
                <button onclick="openCart()" class="relative bg-orange-500 hover:bg-orange-600 text-white px-4 py-2 rounded-lg flex items-center gap-2 transition-colors">
                  <i class="fas fa-shopping-cart"></i>
                  <span class="font-medium hidden sm:inline">Cart</span>
                  ${getCartCount() > 0 ? `<span class="absolute -top-2 -right-2 bg-white text-orange-500 text-xs font-bold w-6 h-6 rounded-full flex items-center justify-center">${getCartCount()}</span>` : ''}
                </button>
              </div>
            </div>
            <div class="mt-4 relative">
              <i class="fas fa-search absolute left-3 top-1/2 -translate-y-1/2 text-slate-400"></i>
              <input type="text" id="searchInput" placeholder="Search by SKU or description..." value="${state.searchQuery}"
                class="w-full pl-10 pr-4 py-3 bg-slate-800 border border-slate-700 rounded-lg text-white placeholder-slate-400 focus:ring-2 focus:ring-orange-500 focus:border-transparent outline-none">
            </div>
          </div>
          <div class="border-t border-slate-800 overflow-x-auto scrollbar-hide">
            <div class="max-w-7xl mx-auto px-4">
              <div class="flex gap-1 py-2">
                ${BRANDS.map(brand => `
                  <button onclick="setBrand('${escHtml(brand)}')" class="px-3 py-2 rounded-lg text-sm font-medium whitespace-nowrap transition-colors flex items-center gap-1 ${state.activeBrand === brand ? 'bg-orange-500 text-white' : 'text-slate-300 hover:bg-slate-800'}">
                    ${escHtml(brand)}
                    <span class="text-xs px-1.5 py-0.5 rounded ${state.activeBrand === brand ? 'bg-orange-600' : 'bg-slate-700'}">${PRODUCT_COUNTS[brand] || 0}</span>
                  </button>
                `).join('')}
              </div>
            </div>
          </div>
        </header>
      `;
    }

    // ========================================
    // MAIN CONTENT
    // ========================================
    function renderMain() {
      if (BRANDS.length === 0) {
        return `
          <main class="max-w-7xl mx-auto px-4 py-12 text-center">
            <i class="fas fa-box-open text-6xl text-slate-300 mb-4"></i>
            <h2 class="text-2xl font-bold text-slate-700 mb-2">No Products Available</h2>
            <p class="text-slate-500">Products haven't been added to this sale yet. Check back soon!</p>
          </main>
        `;
      }

      const data = getFilteredProducts();
      const totalCount = getTotalFilteredCount();

      return `
        <main class="max-w-7xl mx-auto px-4 py-6">
          <div class="mb-4 flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
            <div>
              <h2 class="text-2xl font-bold text-slate-900">${escHtml(state.activeBrand || '')}</h2>
              <p class="text-slate-500">Showing ${totalCount} products</p>
            </div>
            ${data.hasCategories ? renderCategoryNav(data.categories) : ''}
          </div>
          ${data.hasCategories ? renderCategorizedProducts(data.categories) : renderFlatProducts(data.products)}
        </main>
      `;
    }

    function renderCategoryNav(categories) {
      const categoryNames = Object.keys(categories);
      return `
        <div class="flex flex-wrap gap-2">
          ${categoryNames.map(cat => `
            <button onclick="scrollToCategory('cat-${cat.replace(/[^a-zA-Z0-9]/g, '-')}')"
              class="px-3 py-1.5 bg-slate-100 hover:bg-slate-200 text-slate-700 text-sm rounded-full transition-colors">
              ${escHtml(cat)}
            </button>
          `).join('')}
        </div>
      `;
    }

    function renderCategorizedProducts(categories) {
      return Object.entries(categories).map(([category, products]) => `
        <div id="cat-${category.replace(/[^a-zA-Z0-9]/g, '-')}" class="mb-8">
          <div class="bg-gradient-to-r from-slate-800 to-slate-700 text-white px-4 py-3 rounded-t-xl flex items-center gap-3">
            <i class="fas fa-folder-open text-orange-400"></i>
            <h3 class="font-bold text-lg">${escHtml(category)}</h3>
            <span class="bg-orange-500 text-white text-xs px-2 py-0.5 rounded-full">${products.length} items</span>
          </div>
          <div class="bg-white rounded-b-xl shadow-sm overflow-hidden">
            <div class="overflow-x-auto">
              <table class="w-full">
                <thead class="bg-slate-50 border-b">
                  <tr>
                    <th class="text-left px-4 py-3 text-xs font-semibold text-slate-600 uppercase">SKU</th>
                    <th class="text-left px-4 py-3 text-xs font-semibold text-slate-600 uppercase">Description</th>
                    <th class="text-left px-4 py-3 text-xs font-semibold text-slate-600 uppercase">AE Price</th>
                    <th class="text-left px-4 py-3 text-xs font-semibold text-slate-600 uppercase">Sale Price</th>
                    <th class="text-center px-4 py-3 text-xs font-semibold text-slate-600 uppercase">Case Qty</th>
                    <th class="text-right px-4 py-3 text-xs font-semibold text-slate-600 uppercase">Action</th>
                  </tr>
                </thead>
                <tbody class="divide-y">
                  ${products.map(p => renderProductRow(p)).join('')}
                </tbody>
              </table>
            </div>
          </div>
        </div>
      `).join('');
    }

    function renderFlatProducts(products) {
      return `
        <div class="bg-white rounded-xl shadow-sm overflow-hidden">
          <div class="overflow-x-auto">
            <table class="w-full">
              <thead class="bg-slate-50 border-b">
                <tr>
                  <th class="text-left px-4 py-3 text-xs font-semibold text-slate-600 uppercase">SKU</th>
                  <th class="text-left px-4 py-3 text-xs font-semibold text-slate-600 uppercase">Description</th>
                  <th class="text-left px-4 py-3 text-xs font-semibold text-slate-600 uppercase">AE Price</th>
                  <th class="text-left px-4 py-3 text-xs font-semibold text-slate-600 uppercase">Sale Price</th>
                  <th class="text-right px-4 py-3 text-xs font-semibold text-slate-600 uppercase">Action</th>
                </tr>
              </thead>
              <tbody class="divide-y">
                ${products.map(p => renderProductRow(p)).join('')}
              </tbody>
            </table>
          </div>
        </div>
      `;
    }

    function renderProductRow(product) {
      const inCart = state.cart.find(item => item.sku === product.sku);
      const discount = getDiscount(product.previousPrice, product.salePrice);
      const hasPromo = product.promo ? true : false;
      const caseQty = getCaseQty(product);
      const promoRule = PROMO_RULES[product.sku];

      // Case quantity display
      let caseQtyHtml = '';
      if (caseQty > 1) {
        if (promoRule && promoRule.type === 'per_case') {
          caseQtyHtml = `
            <div class="flex flex-col gap-1">
              <span class="inline-flex items-center gap-1 px-2 py-1 bg-blue-50 text-blue-700 text-sm font-medium rounded">
                <i class="fas fa-boxes text-xs"></i>${caseQty}
              </span>
              <span class="text-xs text-green-600 font-semibold">(${promoRule.pay} + 1 FREE)</span>
            </div>`;
        } else {
          caseQtyHtml = `
            <span class="inline-flex items-center gap-1 px-2 py-1 bg-blue-50 text-blue-700 text-sm font-medium rounded">
              <i class="fas fa-boxes text-xs"></i>${caseQty}
            </span>`;
        }
      }

      return `
        <tr class="hover:bg-slate-50 transition-colors ${hasPromo ? 'bg-green-50' : ''}">
          <td class="px-4 py-4">
            <span class="font-mono font-semibold text-blue-600">${escHtml(product.sku)}</span>
          </td>
          <td class="px-4 py-4">
            <p class="font-medium text-slate-900">${escHtml(product.name)}</p>
            ${hasPromo ? `<p class="text-xs mt-1 text-green-700 font-semibold"><i class="fas fa-gift mr-1"></i>${escHtml(product.promo)}</p>` : ''}
          </td>
          <td class="px-4 py-4">
            <span class="text-slate-400 line-through">$${formatPrice(product.previousPrice)}</span>
          </td>
          <td class="px-4 py-4">
            <div class="flex items-center gap-2 flex-wrap">
              <span class="text-lg font-bold text-green-600">$${formatPrice(product.salePrice)}</span>
              ${discount > 0 ? `<span class="px-2 py-0.5 bg-orange-100 text-orange-700 text-xs font-semibold rounded-full">${discount}% OFF</span>` : ''}
            </div>
          </td>
          <td class="px-4 py-4 text-center">${caseQtyHtml}</td>
          <td class="px-4 py-4 text-right">
            ${inCart ? `
              <div class="inline-flex items-center gap-2 bg-slate-100 rounded-lg px-2 py-1">
                <button onclick="updateQuantity('${escHtml(product.sku)}', -1)" class="p-1 hover:bg-slate-200 rounded">
                  <i class="fas fa-minus text-sm"></i>
                </button>
                <span class="font-semibold w-8 text-center">${inCart.quantity}</span>
                <button onclick="updateQuantity('${escHtml(product.sku)}', 1)" class="p-1 hover:bg-slate-200 rounded">
                  <i class="fas fa-plus text-sm"></i>
                </button>
              </div>
            ` : `
              <button onclick='addToCart(${JSON.stringify(product).replace(/'/g, "&#39;")})' class="bg-orange-500 hover:bg-orange-600 text-white px-4 py-2 rounded-lg text-sm font-medium inline-flex items-center gap-2 transition-colors">
                <i class="fas fa-plus"></i> Add ${caseQty > 1 ? caseQty : ''}
              </button>
            `}
          </td>
        </tr>
      `;
    }

    // ========================================
    // CART SIDEBAR
    // ========================================
    function renderCartSidebar() {
      return `
        <div class="fixed inset-0 z-50">
          <div class="absolute inset-0 bg-black/50" onclick="closeCart()"></div>
          <div class="absolute right-0 top-0 bottom-0 w-full max-w-md bg-white shadow-xl flex flex-col">
            <div class="p-4 border-b flex items-center justify-between bg-slate-900 text-white">
              <h2 class="text-lg font-bold flex items-center gap-2">
                <i class="fas fa-shopping-cart"></i>
                Your Cart (${getCartCount()})
              </h2>
              <button onclick="closeCart()" class="p-2 hover:bg-slate-800 rounded-lg">
                <i class="fas fa-times"></i>
              </button>
            </div>
            <div class="flex-1 overflow-auto p-4">
              ${state.cart.length === 0 ? `
                <div class="text-center py-12 text-slate-500">
                  <i class="fas fa-shopping-cart text-4xl opacity-30 mb-4"></i>
                  <p>Your cart is empty</p>
                  <p class="text-sm mt-1">Add products to get started</p>
                </div>
              ` : `
                <div class="space-y-3">
                  ${state.cart.map(item => {
                    const caseQty = getCaseQty(item);
                    const numCases = caseQty > 1 ? Math.floor(item.quantity / caseQty) : item.quantity;
                    const promoInfo = getPromoInfo(item.sku, item.quantity);
                    return `
                    <div class="bg-slate-50 rounded-lg p-3">
                      <div class="flex justify-between items-start mb-2">
                        <div class="flex-1 min-w-0">
                          <p class="font-mono text-sm text-blue-600">${escHtml(item.sku)}</p>
                          <p class="font-medium text-sm truncate">${escHtml(item.name)}</p>
                          ${caseQty > 1 ? `<p class="text-xs text-slate-500 mt-1">${numCases} case(s) × ${caseQty} = ${item.quantity} units</p>` : ''}
                          ${promoInfo ? `<div class="mt-1 bg-green-100 text-green-800 text-xs px-2 py-1 rounded"><i class="fas fa-gift mr-1"></i>${promoInfo.message}</div>` : ''}
                        </div>
                        <button onclick="removeFromCart('${escHtml(item.sku)}')" class="p-1 text-red-500 hover:bg-red-50 rounded ml-2">
                          <i class="fas fa-trash text-sm"></i>
                        </button>
                      </div>
                      <div class="flex items-center justify-between">
                        <div class="flex items-center gap-2 bg-white rounded-lg px-2 py-1 border">
                          <button onclick="updateQuantity('${escHtml(item.sku)}', -1)" class="p-1 hover:bg-slate-100 rounded">
                            <i class="fas fa-minus text-xs"></i>
                          </button>
                          <span class="font-semibold w-6 text-center text-sm">${item.quantity}</span>
                          <button onclick="updateQuantity('${escHtml(item.sku)}', 1)" class="p-1 hover:bg-slate-100 rounded">
                            <i class="fas fa-plus text-xs"></i>
                          </button>
                        </div>
                        <p class="font-bold text-green-600">$${formatPrice(parseFloat(item.salePrice) * item.quantity)}</p>
                      </div>
                    </div>
                  `}).join('')}
                </div>
              `}
            </div>
            ${state.cart.length > 0 ? `
              <div class="p-4 border-t bg-slate-50">
                <div class="flex justify-between items-center mb-4">
                  <span class="font-semibold text-lg">Total:</span>
                  <span class="font-bold text-2xl text-green-600">$${formatPrice(getCartTotal())}</span>
                </div>
                <button onclick="openCheckout()" class="w-full bg-orange-500 hover:bg-orange-600 text-white py-3 rounded-lg font-semibold transition-colors">
                  Proceed to Checkout
                </button>
              </div>
            ` : ''}
          </div>
        </div>
      `;
    }

    // ========================================
    // CHECKOUT MODAL
    // ========================================
    function renderCheckoutModal() {
      return `
        <div class="fixed inset-0 z-50 flex items-center justify-center p-4">
          <div class="absolute inset-0 bg-black/50" onclick="closeCheckout()"></div>
          <div class="relative bg-white rounded-xl shadow-2xl w-full max-w-lg">
            <div class="p-6 border-b">
              <h2 class="text-xl font-bold">Complete Your Order</h2>
              <p class="text-slate-500">Fill in your details to submit</p>
            </div>
            <div class="p-6 space-y-4">
              <div>
                <label class="block text-sm font-medium text-slate-700 mb-1">Shop Name *</label>
                <input type="text" id="shopNameInput" value="${escHtml(state.shopName)}" placeholder="Your auto body shop name"
                  class="w-full px-4 py-3 border border-slate-200 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-transparent outline-none">
              </div>
              <div>
                <label class="block text-sm font-medium text-slate-700 mb-1">Contact Email *</label>
                <input type="email" id="emailInput" value="${escHtml(state.contactEmail)}" placeholder="your@email.com"
                  class="w-full px-4 py-3 border border-slate-200 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-transparent outline-none">
              </div>
              <div>
                <label class="block text-sm font-medium text-slate-700 mb-1">Deliver from Branch *</label>
                <div class="relative">
                  <select id="branchSelect" class="w-full px-4 py-3 border border-slate-200 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-transparent outline-none appearance-none bg-white">
                    <option value="">Select a branch</option>
                    ${BRANCHES.map(b => `<option value="${b}" ${state.branch === b ? 'selected' : ''}>${b}</option>`).join('')}
                  </select>
                  <i class="fas fa-chevron-down absolute right-4 top-1/2 -translate-y-1/2 text-slate-400 pointer-events-none"></i>
                </div>
                <p class="text-xs text-slate-500 mt-1">
                  <i class="fas fa-truck mr-1"></i>
                  Your order will be processed by this branch
                </p>
              </div>
              <div>
                <label class="block text-sm font-medium text-slate-700 mb-1">Order Notes (optional)</label>
                <textarea id="orderNotesInput" placeholder="Any special instructions or notes for your order..." rows="3"
                  class="w-full px-4 py-3 border border-slate-200 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-transparent outline-none resize-none">${escHtml(state.orderNotes)}</textarea>
              </div>
              <div class="bg-slate-50 rounded-lg p-4">
                <div class="flex justify-between items-center">
                  <span class="font-medium">Order Total:</span>
                  <span class="font-bold text-xl text-green-600">$${formatPrice(getCartTotal())}</span>
                </div>
                <p class="text-xs text-slate-500 mt-1">${getCartCount()} items</p>
              </div>
            </div>
            <div class="p-6 border-t bg-slate-50 flex gap-3 rounded-b-xl">
              <button onclick="closeCheckout()" class="flex-1 px-4 py-3 border border-slate-200 rounded-lg font-medium hover:bg-white transition-colors" ${state.isSubmitting ? 'disabled' : ''}>
                Cancel
              </button>
              <button onclick="handleSubmitOrder()" class="flex-1 px-4 py-3 bg-orange-500 hover:bg-orange-600 text-white rounded-lg font-semibold transition-colors flex items-center justify-center gap-2" ${state.isSubmitting ? 'disabled' : ''}>
                ${state.isSubmitting ? `
                  <i class="fas fa-spinner animate-spin"></i>
                  <span>Submitting...</span>
                ` : `
                  <span>Submit Order</span>
                `}
              </button>
            </div>
          </div>
        </div>
      `;
    }

    // ========================================
    // ORDER SUCCESS
    // ========================================
    function renderOrderSuccess() {
      const branchEmail = BRANCH_EMAILS[state.branch];
      return `
        <div class="min-h-screen bg-green-50 flex items-center justify-center p-4">
          <div class="bg-white rounded-2xl shadow-xl p-8 max-w-md w-full text-center">
            <div class="w-20 h-20 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-6">
              <i class="fas fa-check text-4xl text-green-600"></i>
            </div>
            <h1 class="text-2xl font-bold text-gray-900 mb-2">Order Submitted!</h1>
            <p class="text-gray-600 mb-6">Thank you for your order. Your order has been sent to the ${escHtml(state.branch)} branch.</p>
            <div class="bg-gray-50 rounded-lg p-4 mb-6 text-left">
              <p class="text-sm text-gray-500">Order ID</p>
              <p class="font-mono font-medium">${escHtml(state.lastOrderId || '')}</p>
              <p class="text-sm text-gray-500 mt-2">Shop Name</p>
              <p class="font-medium">${escHtml(state.shopName)}</p>
              <p class="text-sm text-gray-500 mt-2">Your Email</p>
              <p class="font-medium">${escHtml(state.contactEmail)}</p>
              <p class="text-sm text-gray-500 mt-2">Deliver from Branch</p>
              <p class="font-medium">${escHtml(state.branch)}</p>
              ${branchEmail ? `
                <p class="text-xs text-slate-400 mt-1">
                  <i class="fas fa-envelope mr-1"></i>
                  Order sent to: ${branchEmail}
                </p>
              ` : ''}
            </div>
            <button onclick="resetOrder()" class="w-full bg-orange-500 hover:bg-orange-600 text-white py-3 rounded-lg font-semibold transition-colors">
              Place Another Order
            </button>
          </div>
        </div>
      `;
    }

    // ========================================
    // TOAST
    // ========================================
    function renderToast() {
      return `
        <div class="fixed bottom-4 right-4 bg-green-600 text-white px-4 py-3 rounded-lg shadow-lg flex items-center gap-2 z-50">
          <i class="fas fa-check"></i>
          <span>${escHtml(state.toast || '')}</span>
        </div>
      `;
    }

    // ========================================
    // HELPERS
    // ========================================
    function escHtml(str) {
      if (!str) return '';
      const div = document.createElement('div');
      div.textContent = str;
      return div.innerHTML;
    }

    function attachEventListeners() {
      const searchInput = document.getElementById('searchInput');
      if (searchInput) {
        searchInput.addEventListener('input', (e) => setSearch(e.target.value));
      }
    }

    // ========================================
    // START
    // ========================================
    initApp();
  </script>
</body>
</html>
