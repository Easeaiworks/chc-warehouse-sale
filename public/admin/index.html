<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>CHC Paint — Admin Dashboard</title>
  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    :root {
      --primary: #f97316;
      --primary-dark: #ea580c;
      --bg: #0f172a;
      --bg-card: #1e293b;
      --bg-input: #334155;
      --text: #f1f5f9;
      --text-muted: #94a3b8;
      --text-dim: #64748b;
      --border: #334155;
      --success: #22c55e;
      --danger: #ef4444;
      --warning: #eab308;
      --info: #3b82f6;
      --sidebar-w: 240px;
      --header-h: 60px;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
    }

    a { color: var(--primary); text-decoration: none; }
    a:hover { text-decoration: underline; }

    /* ============ LOGIN ============ */
    .login-screen {
      display: flex;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
      padding: 20px;
    }

    .login-card {
      background: var(--bg-card);
      border-radius: 16px;
      padding: 40px;
      width: 100%;
      max-width: 400px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.4);
    }

    .login-card .logo {
      text-align: center;
      margin-bottom: 32px;
    }

    .login-card .logo h1 {
      font-size: 24px;
      color: var(--primary);
    }

    .login-card .logo p {
      color: var(--text-muted);
      font-size: 14px;
      margin-top: 4px;
    }

    .form-group {
      margin-bottom: 20px;
    }

    .form-group label {
      display: block;
      font-size: 13px;
      color: var(--text-muted);
      margin-bottom: 6px;
      font-weight: 500;
    }

    input, select, textarea {
      width: 100%;
      padding: 10px 14px;
      background: var(--bg-input);
      border: 1px solid var(--border);
      border-radius: 8px;
      color: var(--text);
      font-size: 14px;
      outline: none;
      transition: border-color 0.2s;
    }

    input:focus, select:focus, textarea:focus {
      border-color: var(--primary);
    }

    input::placeholder, textarea::placeholder {
      color: var(--text-dim);
    }

    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      padding: 10px 20px;
      border: none;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }

    .btn-primary {
      background: var(--primary);
      color: white;
    }
    .btn-primary:hover { background: var(--primary-dark); }

    .btn-secondary {
      background: var(--bg-input);
      color: var(--text);
      border: 1px solid var(--border);
    }
    .btn-secondary:hover { background: var(--border); }

    .btn-danger {
      background: var(--danger);
      color: white;
    }
    .btn-danger:hover { background: #dc2626; }

    .btn-success {
      background: var(--success);
      color: white;
    }
    .btn-success:hover { background: #16a34a; }

    .btn-sm {
      padding: 6px 12px;
      font-size: 12px;
    }

    .btn-full {
      width: 100%;
    }

    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .error-msg {
      background: rgba(239, 68, 68, 0.15);
      color: #fca5a5;
      padding: 10px 14px;
      border-radius: 8px;
      font-size: 13px;
      margin-bottom: 16px;
      display: none;
    }

    .error-msg.visible { display: block; }

    .success-msg {
      background: rgba(34, 197, 94, 0.15);
      color: #86efac;
      padding: 10px 14px;
      border-radius: 8px;
      font-size: 13px;
      margin-bottom: 16px;
      display: none;
    }

    .success-msg.visible { display: block; }

    /* ============ LAYOUT ============ */
    .app-layout {
      display: flex;
      min-height: 100vh;
    }

    .sidebar {
      width: var(--sidebar-w);
      background: var(--bg-card);
      border-right: 1px solid var(--border);
      position: fixed;
      top: 0;
      left: 0;
      bottom: 0;
      display: flex;
      flex-direction: column;
      z-index: 100;
      transition: transform 0.3s;
    }

    .sidebar-header {
      padding: 20px;
      border-bottom: 1px solid var(--border);
    }

    .sidebar-header h2 {
      font-size: 18px;
      color: var(--primary);
    }

    .sidebar-header span {
      font-size: 12px;
      color: var(--text-dim);
    }

    .sidebar-nav {
      flex: 1;
      padding: 12px;
      overflow-y: auto;
    }

    .nav-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 10px 14px;
      border-radius: 8px;
      cursor: pointer;
      color: var(--text-muted);
      font-size: 14px;
      font-weight: 500;
      transition: all 0.15s;
      margin-bottom: 2px;
    }

    .nav-item:hover {
      background: var(--bg-input);
      color: var(--text);
    }

    .nav-item.active {
      background: rgba(249, 115, 22, 0.15);
      color: var(--primary);
    }

    .nav-item .icon { font-size: 18px; width: 24px; text-align: center; }

    .sidebar-footer {
      padding: 16px 20px;
      border-top: 1px solid var(--border);
    }

    .sidebar-footer .admin-name {
      font-size: 13px;
      font-weight: 600;
      color: var(--text);
    }

    .sidebar-footer .admin-role {
      font-size: 11px;
      color: var(--text-dim);
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    .sidebar-footer .logout-btn {
      margin-top: 10px;
      font-size: 13px;
      color: var(--text-dim);
      cursor: pointer;
      background: none;
      border: none;
      padding: 0;
    }
    .sidebar-footer .logout-btn:hover { color: var(--danger); }

    .main-content {
      margin-left: var(--sidebar-w);
      flex: 1;
      padding: 32px;
      max-width: 1200px;
    }

    .page-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 28px;
      flex-wrap: wrap;
      gap: 12px;
    }

    .page-header h1 {
      font-size: 24px;
      font-weight: 700;
    }

    /* ============ STATS CARDS ============ */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 16px;
      margin-bottom: 32px;
    }

    .stat-card {
      background: var(--bg-card);
      border-radius: 12px;
      padding: 20px;
      border: 1px solid var(--border);
    }

    .stat-card .label {
      font-size: 12px;
      color: var(--text-dim);
      text-transform: uppercase;
      letter-spacing: 0.05em;
      margin-bottom: 8px;
    }

    .stat-card .value {
      font-size: 28px;
      font-weight: 700;
    }

    .stat-card .value.orange { color: var(--primary); }
    .stat-card .value.green { color: var(--success); }
    .stat-card .value.blue { color: var(--info); }
    .stat-card .value.yellow { color: var(--warning); }

    /* ============ TABLE ============ */
    .card {
      background: var(--bg-card);
      border-radius: 12px;
      border: 1px solid var(--border);
      overflow: hidden;
      margin-bottom: 24px;
    }

    .card-header {
      padding: 16px 20px;
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      flex-wrap: wrap;
    }

    .card-header h3 {
      font-size: 16px;
      font-weight: 600;
    }

    .card-body { padding: 20px; }

    table {
      width: 100%;
      border-collapse: collapse;
    }

    thead th {
      text-align: left;
      padding: 10px 16px;
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: var(--text-dim);
      background: rgba(0,0,0,0.2);
      border-bottom: 1px solid var(--border);
    }

    tbody td {
      padding: 12px 16px;
      font-size: 13px;
      border-bottom: 1px solid var(--border);
      vertical-align: middle;
    }

    tbody tr:hover {
      background: rgba(249, 115, 22, 0.04);
    }

    tbody tr:last-child td { border-bottom: none; }

    .badge {
      display: inline-block;
      padding: 3px 10px;
      border-radius: 20px;
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.03em;
    }

    .badge-active { background: rgba(34,197,94,0.15); color: #86efac; }
    .badge-draft { background: rgba(148,163,184,0.15); color: #94a3b8; }
    .badge-archived { background: rgba(239,68,68,0.15); color: #fca5a5; }
    .badge-pending { background: rgba(234,179,8,0.15); color: #fde047; }
    .badge-confirmed { background: rgba(59,130,246,0.15); color: #93c5fd; }
    .badge-shipped { background: rgba(139,92,246,0.15); color: #c4b5fd; }
    .badge-delivered { background: rgba(34,197,94,0.15); color: #86efac; }
    .badge-cancelled { background: rgba(239,68,68,0.15); color: #fca5a5; }
    .badge-super { background: rgba(249,115,22,0.15); color: #fdba74; }
    .badge-admin { background: rgba(59,130,246,0.15); color: #93c5fd; }

    /* ============ MODAL ============ */
    .modal-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.6);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      padding: 20px;
    }

    .modal {
      background: var(--bg-card);
      border-radius: 16px;
      width: 100%;
      max-width: 560px;
      max-height: 90vh;
      overflow-y: auto;
      box-shadow: 0 20px 60px rgba(0,0,0,0.5);
    }

    .modal-header {
      padding: 20px 24px;
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .modal-header h3 { font-size: 18px; }

    .modal-close {
      background: none;
      border: none;
      color: var(--text-dim);
      font-size: 24px;
      cursor: pointer;
      padding: 0;
      line-height: 1;
    }
    .modal-close:hover { color: var(--text); }

    .modal-body { padding: 24px; }

    .modal-footer {
      padding: 16px 24px;
      border-top: 1px solid var(--border);
      display: flex;
      justify-content: flex-end;
      gap: 10px;
    }

    /* ============ FILTERS ============ */
    .filters-bar {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      margin-bottom: 20px;
    }

    .filters-bar input,
    .filters-bar select {
      width: auto;
      min-width: 160px;
    }

    /* ============ FILE UPLOAD ============ */
    .upload-zone {
      border: 2px dashed var(--border);
      border-radius: 12px;
      padding: 40px 20px;
      text-align: center;
      cursor: pointer;
      transition: all 0.2s;
    }

    .upload-zone:hover,
    .upload-zone.dragover {
      border-color: var(--primary);
      background: rgba(249, 115, 22, 0.05);
    }

    .upload-zone .icon { font-size: 40px; margin-bottom: 12px; }
    .upload-zone p { color: var(--text-muted); font-size: 14px; }
    .upload-zone .hint { color: var(--text-dim); font-size: 12px; margin-top: 8px; }

    .upload-result {
      padding: 16px;
      border-radius: 8px;
      margin-top: 16px;
      font-size: 13px;
    }

    .upload-result.success { background: rgba(34,197,94,0.1); color: #86efac; }
    .upload-result.error { background: rgba(239,68,68,0.1); color: #fca5a5; }

    /* ============ MISC ============ */
    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: var(--text-dim);
    }

    .empty-state .icon { font-size: 48px; margin-bottom: 16px; }
    .empty-state h3 { color: var(--text-muted); margin-bottom: 8px; }

    .spinner {
      display: inline-block;
      width: 16px;
      height: 16px;
      border: 2px solid transparent;
      border-top-color: currentColor;
      border-radius: 50%;
      animation: spin 0.6s linear infinite;
    }

    @keyframes spin { to { transform: rotate(360deg); } }

    .text-muted { color: var(--text-muted); }
    .text-dim { color: var(--text-dim); }
    .text-sm { font-size: 13px; }
    .text-xs { font-size: 11px; }
    .mt-2 { margin-top: 8px; }
    .mt-4 { margin-top: 16px; }
    .mb-4 { margin-bottom: 16px; }
    .flex { display: flex; }
    .flex-wrap { flex-wrap: wrap; }
    .gap-2 { gap: 8px; }
    .gap-3 { gap: 12px; }
    .items-center { align-items: center; }

    .mono { font-family: 'SF Mono', 'Consolas', monospace; }

    /* ============ RESPONSIVE ============ */
    .menu-toggle {
      display: none;
      position: fixed;
      top: 14px;
      left: 14px;
      z-index: 200;
      background: var(--bg-card);
      border: 1px solid var(--border);
      color: var(--text);
      font-size: 20px;
      padding: 8px 12px;
      border-radius: 8px;
      cursor: pointer;
    }

    @media (max-width: 768px) {
      .menu-toggle { display: block; }
      .sidebar { transform: translateX(-100%); }
      .sidebar.open { transform: translateX(0); }
      .main-content { margin-left: 0; padding: 20px; padding-top: 60px; }
      .stats-grid { grid-template-columns: 1fr 1fr; }
      .filters-bar input, .filters-bar select { min-width: 120px; }
      table { font-size: 12px; }
      thead th, tbody td { padding: 8px 10px; }
    }

    @media (max-width: 480px) {
      .stats-grid { grid-template-columns: 1fr; }
    }

    /* ============ ORDER DETAIL ============ */
    .order-items-table td { font-size: 12px; padding: 6px 10px; }
    .order-items-table th { font-size: 10px; padding: 6px 10px; }
    .detail-row { display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid var(--border); font-size: 13px; }
    .detail-row .label { color: var(--text-dim); }
  </style>
</head>
<body>

<!-- ========== LOGIN SCREEN ========== -->
<div id="loginScreen" class="login-screen">
  <div class="login-card">
    <div class="logo">
      <h1>CHC Paint</h1>
      <p>Admin Dashboard</p>
    </div>

    <div id="loginSetupMsg" style="display:none; text-align:center; margin-bottom:20px;">
      <p style="color: var(--success); font-size: 13px;">No admins found. Create the first super admin account.</p>
    </div>

    <div id="loginError" class="error-msg"></div>

    <div id="loginNameGroup" class="form-group" style="display:none;">
      <label>Full Name</label>
      <input type="text" id="loginName" placeholder="Your name">
    </div>

    <div class="form-group">
      <label>Email</label>
      <input type="email" id="loginEmail" placeholder="admin@chcpaint.com">
    </div>

    <div class="form-group">
      <label>Password</label>
      <input type="password" id="loginPassword" placeholder="Enter password">
    </div>

    <button class="btn btn-primary btn-full" id="loginBtn" onclick="handleLogin()">
      Sign In
    </button>
  </div>
</div>

<!-- ========== APP LAYOUT ========== -->
<div id="appLayout" class="app-layout" style="display:none;">

  <button class="menu-toggle" onclick="toggleSidebar()">&#9776;</button>

  <aside class="sidebar" id="sidebar">
    <div class="sidebar-header">
      <h2>CHC Paint</h2>
      <span>Admin Dashboard</span>
    </div>

    <nav class="sidebar-nav">
      <div class="nav-item active" data-page="dashboard" onclick="navigate('dashboard')">
        <span class="icon">&#x1f4ca;</span> Dashboard
      </div>
      <div class="nav-item" data-page="sales" onclick="navigate('sales')">
        <span class="icon">&#x1f3f7;</span> Sales
      </div>
      <div class="nav-item" data-page="products" onclick="navigate('products')">
        <span class="icon">&#x1f4e6;</span> Products
      </div>
      <div class="nav-item" data-page="orders" onclick="navigate('orders')">
        <span class="icon">&#x1f4cb;</span> Orders
      </div>
      <div class="nav-item" data-page="users" onclick="navigate('users')" id="navUsers" style="display:none;">
        <span class="icon">&#x1f465;</span> Admin Users
      </div>
    </nav>

    <div class="sidebar-footer">
      <div class="admin-name" id="adminName">—</div>
      <div class="admin-role" id="adminRole">—</div>
      <button class="logout-btn" onclick="logout()">Sign Out</button>
    </div>
  </aside>

  <main class="main-content">
    <!-- DASHBOARD -->
    <div id="pageDashboard" class="page">
      <div class="page-header">
        <h1>Dashboard</h1>
      </div>
      <div class="stats-grid" id="statsGrid">
        <div class="stat-card"><div class="label">Active Sales</div><div class="value orange" id="statActiveSales">—</div></div>
        <div class="stat-card"><div class="label">Total Orders</div><div class="value blue" id="statTotalOrders">—</div></div>
        <div class="stat-card"><div class="label">Pending Orders</div><div class="value yellow" id="statPendingOrders">—</div></div>
        <div class="stat-card"><div class="label">Revenue</div><div class="value green" id="statRevenue">—</div></div>
      </div>
      <div class="card">
        <div class="card-header"><h3>Recent Orders</h3></div>
        <div id="recentOrdersTable"></div>
      </div>
    </div>

    <!-- SALES -->
    <div id="pageSales" class="page" style="display:none;">
      <div class="page-header">
        <h1>Sales</h1>
        <button class="btn btn-primary" onclick="openSaleModal()">+ New Sale</button>
      </div>
      <div class="card">
        <div id="salesTable"></div>
      </div>
    </div>

    <!-- PRODUCTS -->
    <div id="pageProducts" class="page" style="display:none;">
      <div class="page-header">
        <h1>Products</h1>
      </div>

      <div class="form-group" style="max-width:400px; margin-bottom:20px;">
        <label>Select Sale</label>
        <select id="productSaleSelect" onchange="loadProducts()">
          <option value="">— Choose a sale —</option>
        </select>
      </div>

      <div id="productActions" style="display:none;">
        <div class="flex gap-2 mb-4 flex-wrap">
          <button class="btn btn-primary btn-sm" onclick="openProductUpload()">Upload CSV/Excel</button>
          <button class="btn btn-secondary btn-sm" onclick="openAddProduct()">+ Add Product</button>
          <button class="btn btn-danger btn-sm" onclick="clearAllProducts()">Clear All</button>
          <input type="text" id="productSearch" placeholder="Search SKU or name…" style="width:200px;" oninput="debounceProductSearch()">
        </div>

        <div class="card">
          <div class="card-header">
            <h3>Products <span id="productCount" class="text-dim text-sm"></span></h3>
          </div>
          <div id="productsTable"></div>
        </div>
      </div>
    </div>

    <!-- ORDERS -->
    <div id="pageOrders" class="page" style="display:none;">
      <div class="page-header">
        <h1>Orders</h1>
      </div>

      <div class="filters-bar">
        <select id="orderSaleFilter" onchange="loadOrders()">
          <option value="">All Sales</option>
        </select>
        <select id="orderStatusFilter" onchange="loadOrders()">
          <option value="">All Statuses</option>
          <option value="pending">Pending</option>
          <option value="confirmed">Confirmed</option>
          <option value="shipped">Shipped</option>
          <option value="delivered">Delivered</option>
          <option value="cancelled">Cancelled</option>
        </select>
        <select id="orderBranchFilter" onchange="loadOrders()">
          <option value="">All Branches</option>
          <option value="Woodbridge">Woodbridge</option>
          <option value="Markham">Markham</option>
          <option value="Ottawa">Ottawa</option>
          <option value="Hamilton">Hamilton</option>
          <option value="Oakville">Oakville</option>
          <option value="St. Catharines">St. Catharines</option>
        </select>
      </div>

      <div class="card">
        <div id="ordersTable"></div>
      </div>
    </div>

    <!-- ADMIN USERS -->
    <div id="pageUsers" class="page" style="display:none;">
      <div class="page-header">
        <h1>Admin Users</h1>
        <button class="btn btn-primary" onclick="openAddAdmin()">+ Add Admin</button>
      </div>
      <div class="card">
        <div id="usersTable"></div>
      </div>
    </div>
  </main>
</div>

<!-- ========== MODAL CONTAINER ========== -->
<div id="modalContainer"></div>

<script>
// ============================================
// STATE
// ============================================
const API = '';
let token = localStorage.getItem('chc_admin_token');
let admin = null;
let currentPage = 'dashboard';
let salesCache = [];
let productSearchTimer = null;

// ============================================
// API HELPER
// ============================================
async function api(endpoint, options = {}) {
  const headers = { 'Content-Type': 'application/json' };
  if (token) headers['Authorization'] = `Bearer ${token}`;

  if (options.body && !(options.body instanceof FormData)) {
    options.body = JSON.stringify(options.body);
  } else if (options.body instanceof FormData) {
    delete headers['Content-Type'];
  }

  const res = await fetch(API + endpoint, { ...options, headers: options.body instanceof FormData ? { 'Authorization': `Bearer ${token}` } : headers });

  // Only auto-logout for 401 on non-auth endpoints
  const isAuthEndpoint = endpoint.includes('/auth/login') || endpoint.includes('/auth/register');
  if (res.status === 401 && !isAuthEndpoint) {
    logout();
    throw new Error('Session expired');
  }

  const data = await res.json();
  if (!res.ok) throw new Error(data.error || 'Request failed');
  return data;
}

// Direct fetch for login (bypasses api() helper entirely)
async function loginFetch(endpoint, body) {
  const res = await fetch(API + endpoint, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json', ...(token ? { 'Authorization': `Bearer ${token}` } : {}) },
    body: JSON.stringify(body)
  });
  const data = await res.json();
  if (!res.ok) throw new Error(data.error || 'Request failed');
  return data;
}

// ============================================
// AUTH
// ============================================
async function initApp() {
  if (!token) {
    checkFirstAdmin();
    return;
  }

  try {
    const data = await api('/api/admin/auth/me');
    admin = data.admin;
    showApp();
  } catch (e) {
    token = null;
    localStorage.removeItem('chc_admin_token');
    checkFirstAdmin();
  }
}

async function checkFirstAdmin() {
  document.getElementById('loginScreen').style.display = 'flex';
  document.getElementById('appLayout').style.display = 'none';
  // Login screen shows by default. First-admin detection is handled
  // server-side by the register endpoint — no need to probe here.
}

async function handleLogin() {
  const btn = document.getElementById('loginBtn');
  const errorEl = document.getElementById('loginError');
  const email = document.getElementById('loginEmail').value.trim();
  const password = document.getElementById('loginPassword').value;
  const name = document.getElementById('loginName').value.trim();

  if (!email || !password) {
    errorEl.textContent = 'Please enter email and password';
    errorEl.classList.add('visible');
    return;
  }

  btn.disabled = true;
  btn.innerHTML = '<span class="spinner"></span> Signing in…';
  errorEl.classList.remove('visible');

  try {
    // Try login first
    const data = await loginFetch('/api/admin/auth/login', { email, password });

    token = data.token;
    admin = data.admin;
    localStorage.setItem('chc_admin_token', token);
    showApp();
  } catch (loginErr) {
    // If login fails and name field is visible (setup mode), try register
    if (name) {
      try {
        const data = await loginFetch('/api/admin/auth/register', { email, password, name });

        token = data.token;
        admin = data.admin;
        localStorage.setItem('chc_admin_token', token);
        showApp();
        return;
      } catch (regErr) {
        errorEl.textContent = regErr.message;
        errorEl.classList.add('visible');
      }
    } else {
      // Show name field for first-time setup
      if (loginErr.message.includes('Invalid email') || loginErr.message.includes('Invalid')) {
        // Could be first admin — show name field
        document.getElementById('loginNameGroup').style.display = 'block';
        document.getElementById('loginSetupMsg').style.display = 'block';
        document.getElementById('loginBtn').textContent = 'Create Account';
        errorEl.textContent = 'No account found. If you\'re setting up for the first time, enter your name and click Create Account.';
        errorEl.classList.add('visible');
      } else {
        errorEl.textContent = loginErr.message;
        errorEl.classList.add('visible');
      }
    }
  } finally {
    btn.disabled = false;
    if (btn.textContent !== 'Create Account') {
      btn.innerHTML = document.getElementById('loginNameGroup').style.display === 'block' ? 'Create Account' : 'Sign In';
    }
  }
}

// Enter key for login
document.getElementById('loginPassword').addEventListener('keydown', (e) => {
  if (e.key === 'Enter') handleLogin();
});

function logout() {
  token = null;
  admin = null;
  localStorage.removeItem('chc_admin_token');
  document.getElementById('loginScreen').style.display = 'flex';
  document.getElementById('appLayout').style.display = 'none';
  document.getElementById('loginEmail').value = '';
  document.getElementById('loginPassword').value = '';
  document.getElementById('loginName').value = '';
  document.getElementById('loginNameGroup').style.display = 'none';
  document.getElementById('loginSetupMsg').style.display = 'none';
  document.getElementById('loginError').classList.remove('visible');
  document.getElementById('loginBtn').innerHTML = 'Sign In';
}

function showApp() {
  document.getElementById('loginScreen').style.display = 'none';
  document.getElementById('appLayout').style.display = 'flex';
  document.getElementById('adminName').textContent = admin.name;
  document.getElementById('adminRole').textContent = admin.role.replace('_', ' ');

  if (admin.role === 'super_admin') {
    document.getElementById('navUsers').style.display = 'flex';
  }

  navigate('dashboard');
}

// ============================================
// NAVIGATION
// ============================================
function navigate(page) {
  currentPage = page;

  document.querySelectorAll('.page').forEach(p => p.style.display = 'none');
  document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));

  const pageEl = document.getElementById('page' + page.charAt(0).toUpperCase() + page.slice(1));
  if (pageEl) pageEl.style.display = 'block';

  const navEl = document.querySelector(`.nav-item[data-page="${page}"]`);
  if (navEl) navEl.classList.add('active');

  // Close mobile sidebar
  document.getElementById('sidebar').classList.remove('open');

  // Load data
  switch (page) {
    case 'dashboard': loadDashboard(); break;
    case 'sales': loadSales(); break;
    case 'products': loadSalesDropdown(); break;
    case 'orders': loadSalesForFilter(); loadOrders(); break;
    case 'users': loadUsers(); break;
  }
}

function toggleSidebar() {
  document.getElementById('sidebar').classList.toggle('open');
}

// ============================================
// DASHBOARD
// ============================================
async function loadDashboard() {
  try {
    const stats = await api('/api/admin/stats');
    document.getElementById('statActiveSales').textContent = stats.active_sales;
    document.getElementById('statTotalOrders').textContent = stats.total_orders;
    document.getElementById('statPendingOrders').textContent = stats.pending_orders;
    document.getElementById('statRevenue').textContent = '$' + stats.total_revenue.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
  } catch (e) {
    console.error('Failed to load stats:', e);
  }

  // Recent orders
  try {
    const orders = await api('/api/admin/orders?limit=10');
    renderRecentOrders(orders.slice(0, 10));
  } catch (e) {
    console.error('Failed to load recent orders:', e);
  }
}

function renderRecentOrders(orders) {
  const el = document.getElementById('recentOrdersTable');
  if (!orders.length) {
    el.innerHTML = '<div class="empty-state"><div class="icon">&#x1f4cb;</div><h3>No orders yet</h3><p>Orders will appear here once customers start placing them.</p></div>';
    return;
  }

  el.innerHTML = `
    <table>
      <thead>
        <tr>
          <th>Order</th>
          <th>Shop</th>
          <th>Branch</th>
          <th>Total</th>
          <th>Status</th>
          <th>Date</th>
        </tr>
      </thead>
      <tbody>
        ${orders.map(o => `
          <tr style="cursor:pointer" onclick="showOrderDetail('${o.id}')">
            <td class="mono" style="color: var(--info)">${o.order_code}</td>
            <td>${esc(o.shop_name)}</td>
            <td>${esc(o.branch)}</td>
            <td style="font-weight:600; color:var(--success)">$${parseFloat(o.total).toFixed(2)}</td>
            <td><span class="badge badge-${o.status}">${o.status}</span></td>
            <td class="text-dim">${formatDate(o.created_at)}</td>
          </tr>
        `).join('')}
      </tbody>
    </table>
  `;
}

// ============================================
// SALES
// ============================================
async function loadSales() {
  const el = document.getElementById('salesTable');
  el.innerHTML = '<div class="card-body"><span class="spinner"></span> Loading…</div>';

  try {
    salesCache = await api('/api/admin/sales');
    renderSales();
  } catch (e) {
    el.innerHTML = `<div class="card-body" style="color:var(--danger)">Failed to load sales: ${esc(e.message)}</div>`;
  }
}

function renderSales() {
  const el = document.getElementById('salesTable');

  if (!salesCache.length) {
    el.innerHTML = '<div class="empty-state"><div class="icon">&#x1f3f7;</div><h3>No sales created</h3><p>Create your first sale to get started.</p></div>';
    return;
  }

  el.innerHTML = `
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Slug</th>
          <th>Status</th>
          <th>Products</th>
          <th>Orders</th>
          <th>Created</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        ${salesCache.map(s => `
          <tr>
            <td style="font-weight:600">${esc(s.name)}</td>
            <td class="mono text-dim">${esc(s.slug)}</td>
            <td><span class="badge badge-${s.status}">${s.status}</span></td>
            <td>${s.product_count}</td>
            <td>${s.order_count}</td>
            <td class="text-dim">${formatDate(s.created_at)}</td>
            <td>
              <div class="flex gap-2">
                <button class="btn btn-secondary btn-sm" onclick="openSaleModal('${s.id}')">Edit</button>
                ${s.status !== 'archived' ? `<button class="btn btn-danger btn-sm" onclick="archiveSale('${s.id}', '${esc(s.name)}')">Archive</button>` : ''}
              </div>
            </td>
          </tr>
        `).join('')}
      </tbody>
    </table>
  `;
}

function openSaleModal(saleId) {
  const sale = saleId ? salesCache.find(s => s.id === saleId) : null;
  const isEdit = !!sale;

  document.getElementById('modalContainer').innerHTML = `
    <div class="modal-backdrop" onclick="closeModal(event)">
      <div class="modal" onclick="event.stopPropagation()">
        <div class="modal-header">
          <h3>${isEdit ? 'Edit Sale' : 'Create New Sale'}</h3>
          <button class="modal-close" onclick="closeModal()">&times;</button>
        </div>
        <div class="modal-body">
          <div id="saleModalError" class="error-msg"></div>

          <div class="form-group">
            <label>Sale Name *</label>
            <input type="text" id="saleName" value="${isEdit ? esc(sale.name) : ''}" placeholder="Warehouse Sale 2026">
          </div>

          <div class="form-group">
            <label>URL Slug *</label>
            <input type="text" id="saleSlug" value="${isEdit ? esc(sale.slug) : ''}" placeholder="warehouse-sale-2026" ${isEdit ? '' : 'oninput="autoSlug()"'}>
            <small class="text-dim">Lowercase, hyphens only. Used in URLs.</small>
          </div>

          <div class="form-group">
            <label>Description</label>
            <textarea id="saleDesc" rows="2" placeholder="Optional description">${isEdit ? esc(sale.description || '') : ''}</textarea>
          </div>

          <div class="form-group">
            <label>${isEdit ? 'Change Password (leave blank to keep)' : 'Access Password *'}</label>
            <input type="text" id="salePassword" placeholder="${isEdit ? 'Leave blank to keep current' : 'Password for customers'}">
          </div>

          <div class="form-group">
            <label>Status</label>
            <select id="saleStatus">
              <option value="draft" ${sale && sale.status === 'draft' ? 'selected' : ''}>Draft</option>
              <option value="active" ${sale && sale.status === 'active' ? 'selected' : ''}>Active</option>
              <option value="archived" ${sale && sale.status === 'archived' ? 'selected' : ''}>Archived</option>
            </select>
          </div>

          <div class="flex gap-2">
            <div class="form-group" style="flex:1">
              <label>Start Date</label>
              <input type="date" id="saleStart" value="${sale && sale.start_date ? sale.start_date.substring(0,10) : ''}">
            </div>
            <div class="form-group" style="flex:1">
              <label>End Date</label>
              <input type="date" id="saleEnd" value="${sale && sale.end_date ? sale.end_date.substring(0,10) : ''}">
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" onclick="closeModal()">Cancel</button>
          <button class="btn btn-primary" id="saveSaleBtn" onclick="saveSale('${saleId || ''}')">${isEdit ? 'Save Changes' : 'Create Sale'}</button>
        </div>
      </div>
    </div>
  `;
}

function autoSlug() {
  const name = document.getElementById('saleName').value;
  document.getElementById('saleSlug').value = name.toLowerCase().replace(/[^a-z0-9]+/g, '-').replace(/(^-|-$)/g, '');
}

async function saveSale(saleId) {
  const btn = document.getElementById('saveSaleBtn');
  const errEl = document.getElementById('saleModalError');

  const name = document.getElementById('saleName').value.trim();
  const slug = document.getElementById('saleSlug').value.trim();
  const description = document.getElementById('saleDesc').value.trim();
  const password = document.getElementById('salePassword').value;
  const status = document.getElementById('saleStatus').value;
  const start_date = document.getElementById('saleStart').value || null;
  const end_date = document.getElementById('saleEnd').value || null;

  if (!name || !slug) {
    errEl.textContent = 'Name and slug are required';
    errEl.classList.add('visible');
    return;
  }

  if (!saleId && !password) {
    errEl.textContent = 'Password is required for new sales';
    errEl.classList.add('visible');
    return;
  }

  btn.disabled = true;
  btn.innerHTML = '<span class="spinner"></span> Saving…';
  errEl.classList.remove('visible');

  try {
    const body = { name, slug, description, status, start_date, end_date };
    if (password) body.password = password;

    if (saleId) {
      await api(`/api/admin/sales/${saleId}`, { method: 'PATCH', body });
    } else {
      await api('/api/admin/sales', { method: 'POST', body });
    }

    closeModal();
    loadSales();
  } catch (e) {
    errEl.textContent = e.message;
    errEl.classList.add('visible');
    btn.disabled = false;
    btn.textContent = saleId ? 'Save Changes' : 'Create Sale';
  }
}

async function archiveSale(id, name) {
  if (!confirm(`Archive "${name}"? This will hide it from customers.`)) return;

  try {
    await api(`/api/admin/sales/${id}`, { method: 'DELETE' });
    loadSales();
  } catch (e) {
    alert('Failed to archive: ' + e.message);
  }
}

// ============================================
// PRODUCTS
// ============================================
async function loadSalesDropdown() {
  try {
    salesCache = await api('/api/admin/sales');
    const select = document.getElementById('productSaleSelect');
    const current = select.value;
    select.innerHTML = '<option value="">— Choose a sale —</option>' +
      salesCache.map(s => `<option value="${s.id}" ${s.id === current ? 'selected' : ''}>${esc(s.name)} (${s.status})</option>`).join('');
    if (current) loadProducts();
  } catch (e) {
    console.error('Failed to load sales:', e);
  }
}

async function loadProducts() {
  const saleId = document.getElementById('productSaleSelect').value;
  const actionsEl = document.getElementById('productActions');
  const tableEl = document.getElementById('productsTable');

  if (!saleId) {
    actionsEl.style.display = 'none';
    return;
  }

  actionsEl.style.display = 'block';
  tableEl.innerHTML = '<div class="card-body"><span class="spinner"></span> Loading…</div>';

  try {
    const search = document.getElementById('productSearch').value.trim();
    let url = `/api/admin/sales/${saleId}/products`;
    if (search) url += `?search=${encodeURIComponent(search)}`;

    const products = await api(url);
    renderProducts(products, saleId);
  } catch (e) {
    tableEl.innerHTML = `<div class="card-body" style="color:var(--danger)">${esc(e.message)}</div>`;
  }
}

function renderProducts(products, saleId) {
  const el = document.getElementById('productsTable');
  document.getElementById('productCount').textContent = `(${products.length} products)`;

  if (!products.length) {
    el.innerHTML = '<div class="empty-state"><div class="icon">&#x1f4e6;</div><h3>No products</h3><p>Upload a CSV/Excel file or add products manually.</p></div>';
    return;
  }

  el.innerHTML = `
    <table>
      <thead>
        <tr>
          <th>SKU</th>
          <th>Brand</th>
          <th>Category</th>
          <th>Name</th>
          <th>Prev Price</th>
          <th>Sale Price</th>
          <th>Promo</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        ${products.map(p => `
          <tr>
            <td class="mono" style="color: var(--info)">${esc(p.sku)}</td>
            <td>${esc(p.brand)}</td>
            <td class="text-dim">${esc(p.category || '—')}</td>
            <td>${esc(p.name)}</td>
            <td>$${parseFloat(p.previous_price).toFixed(2)}</td>
            <td style="font-weight:600; color:var(--success)">$${parseFloat(p.sale_price).toFixed(2)}</td>
            <td class="text-dim text-xs">${esc(p.promo || '—')}</td>
            <td>
              <div class="flex gap-2">
                <button class="btn btn-secondary btn-sm" onclick='editProduct(${JSON.stringify(p).replace(/'/g, "&#39;")})'>Edit</button>
                <button class="btn btn-danger btn-sm" onclick="deleteProduct('${saleId}','${p.id}')">Del</button>
              </div>
            </td>
          </tr>
        `).join('')}
      </tbody>
    </table>
  `;
}

function debounceProductSearch() {
  clearTimeout(productSearchTimer);
  productSearchTimer = setTimeout(loadProducts, 300);
}

function openProductUpload() {
  const saleId = document.getElementById('productSaleSelect').value;
  if (!saleId) return;

  document.getElementById('modalContainer').innerHTML = `
    <div class="modal-backdrop" onclick="closeModal(event)">
      <div class="modal" onclick="event.stopPropagation()">
        <div class="modal-header">
          <h3>Upload Products</h3>
          <button class="modal-close" onclick="closeModal()">&times;</button>
        </div>
        <div class="modal-body">
          <div class="upload-zone" id="uploadZone" onclick="document.getElementById('fileInput').click()">
            <div class="icon">&#x1f4c1;</div>
            <p>Click or drag a file here</p>
            <div class="hint">Supports .xlsx, .xls, and .csv files (max 10MB)</div>
          </div>
          <input type="file" id="fileInput" style="display:none" accept=".csv,.xlsx,.xls" onchange="handleFileSelect(this)">

          <div class="mt-4">
            <p class="text-sm text-muted">Required columns: <strong>sku</strong>, <strong>brand</strong>, <strong>name</strong>, <strong>previous_price</strong>, <strong>sale_price</strong></p>
            <p class="text-sm text-dim mt-2">Optional: category, promo</p>
            <p class="text-sm text-dim mt-2">Column names are flexible — we accept aliases like "product_code" for SKU, "msrp" for previous_price, etc.</p>
          </div>

          <div id="uploadResult" style="display:none"></div>
          <div id="uploadProgress" style="display:none" class="mt-4">
            <span class="spinner"></span> Uploading and processing…
          </div>
        </div>
      </div>
    </div>
  `;

  // Drag & drop
  const zone = document.getElementById('uploadZone');
  zone.addEventListener('dragover', (e) => { e.preventDefault(); zone.classList.add('dragover'); });
  zone.addEventListener('dragleave', () => zone.classList.remove('dragover'));
  zone.addEventListener('drop', (e) => {
    e.preventDefault();
    zone.classList.remove('dragover');
    if (e.dataTransfer.files.length) {
      document.getElementById('fileInput').files = e.dataTransfer.files;
      handleFileSelect(document.getElementById('fileInput'));
    }
  });
}

async function handleFileSelect(input) {
  if (!input.files.length) return;

  const saleId = document.getElementById('productSaleSelect').value;
  const file = input.files[0];
  const resultEl = document.getElementById('uploadResult');
  const progressEl = document.getElementById('uploadProgress');

  progressEl.style.display = 'block';
  resultEl.style.display = 'none';

  const formData = new FormData();
  formData.append('file', file);

  try {
    const res = await fetch(`${API}/api/admin/sales/${saleId}/products/upload`, {
      method: 'POST',
      headers: { 'Authorization': `Bearer ${token}` },
      body: formData
    });

    const data = await res.json();

    if (!res.ok) throw new Error(data.error || 'Upload failed');

    resultEl.style.display = 'block';
    resultEl.className = 'upload-result success';
    resultEl.innerHTML = `
      <strong>Upload complete!</strong><br>
      Total rows: ${data.total_rows}<br>
      Added/Updated: ${data.added}<br>
      Failed: ${data.failed}
      ${data.failures && data.failures.length ? `<br><br><strong>First failures:</strong><br>${data.failures.map(f => `Row ${f.row}: ${esc(f.reason)}`).join('<br>')}` : ''}
    `;

    loadProducts();
  } catch (e) {
    resultEl.style.display = 'block';
    resultEl.className = 'upload-result error';
    resultEl.textContent = 'Upload failed: ' + e.message;
  } finally {
    progressEl.style.display = 'none';
  }
}

function openAddProduct() {
  editProduct(null);
}

function editProduct(product) {
  const saleId = document.getElementById('productSaleSelect').value;
  if (!saleId) return;
  const isEdit = !!product;

  document.getElementById('modalContainer').innerHTML = `
    <div class="modal-backdrop" onclick="closeModal(event)">
      <div class="modal" onclick="event.stopPropagation()">
        <div class="modal-header">
          <h3>${isEdit ? 'Edit Product' : 'Add Product'}</h3>
          <button class="modal-close" onclick="closeModal()">&times;</button>
        </div>
        <div class="modal-body">
          <div id="productModalError" class="error-msg"></div>
          <div class="flex gap-2">
            <div class="form-group" style="flex:1"><label>SKU *</label><input type="text" id="prodSku" value="${isEdit ? esc(product.sku) : ''}"></div>
            <div class="form-group" style="flex:1"><label>Brand *</label><input type="text" id="prodBrand" value="${isEdit ? esc(product.brand) : ''}"></div>
          </div>
          <div class="form-group"><label>Category</label><input type="text" id="prodCategory" value="${isEdit ? esc(product.category || '') : ''}"></div>
          <div class="form-group"><label>Name *</label><input type="text" id="prodName" value="${isEdit ? esc(product.name) : ''}"></div>
          <div class="flex gap-2">
            <div class="form-group" style="flex:1"><label>Previous Price *</label><input type="number" step="0.01" id="prodPrevPrice" value="${isEdit ? product.previous_price : ''}"></div>
            <div class="form-group" style="flex:1"><label>Sale Price *</label><input type="number" step="0.01" id="prodSalePrice" value="${isEdit ? product.sale_price : ''}"></div>
          </div>
          <div class="form-group"><label>Promo Text</label><input type="text" id="prodPromo" value="${isEdit ? esc(product.promo || '') : ''}" placeholder="e.g., Buy 2 Get 1 Free"></div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" onclick="closeModal()">Cancel</button>
          <button class="btn btn-primary" id="saveProductBtn" onclick="saveProduct('${saleId}', '${isEdit ? product.id : ''}')">${isEdit ? 'Save' : 'Add Product'}</button>
        </div>
      </div>
    </div>
  `;
}

async function saveProduct(saleId, productId) {
  const btn = document.getElementById('saveProductBtn');
  const errEl = document.getElementById('productModalError');

  const body = {
    sku: document.getElementById('prodSku').value.trim(),
    brand: document.getElementById('prodBrand').value.trim(),
    category: document.getElementById('prodCategory').value.trim(),
    name: document.getElementById('prodName').value.trim(),
    previous_price: document.getElementById('prodPrevPrice').value,
    sale_price: document.getElementById('prodSalePrice').value,
    promo: document.getElementById('prodPromo').value.trim()
  };

  if (!body.sku || !body.brand || !body.name || !body.previous_price || !body.sale_price) {
    errEl.textContent = 'SKU, brand, name, and prices are required';
    errEl.classList.add('visible');
    return;
  }

  btn.disabled = true;
  btn.innerHTML = '<span class="spinner"></span>';
  errEl.classList.remove('visible');

  try {
    if (productId) {
      await api(`/api/admin/sales/${saleId}/products/${productId}`, { method: 'PATCH', body });
    } else {
      await api(`/api/admin/sales/${saleId}/products`, { method: 'POST', body });
    }
    closeModal();
    loadProducts();
  } catch (e) {
    errEl.textContent = e.message;
    errEl.classList.add('visible');
    btn.disabled = false;
    btn.textContent = productId ? 'Save' : 'Add Product';
  }
}

async function deleteProduct(saleId, productId) {
  if (!confirm('Delete this product?')) return;
  try {
    await api(`/api/admin/sales/${saleId}/products/${productId}`, { method: 'DELETE' });
    loadProducts();
  } catch (e) {
    alert('Failed: ' + e.message);
  }
}

async function clearAllProducts() {
  const saleId = document.getElementById('productSaleSelect').value;
  if (!saleId) return;
  if (!confirm('Delete ALL products for this sale? This cannot be undone.')) return;
  if (!confirm('Are you sure? This will remove every product from this sale.')) return;

  try {
    await api(`/api/admin/sales/${saleId}/products`, { method: 'DELETE' });
    loadProducts();
  } catch (e) {
    alert('Failed: ' + e.message);
  }
}

// ============================================
// ORDERS
// ============================================
async function loadSalesForFilter() {
  try {
    if (!salesCache.length) {
      salesCache = await api('/api/admin/sales');
    }
    const select = document.getElementById('orderSaleFilter');
    const current = select.value;
    select.innerHTML = '<option value="">All Sales</option>' +
      salesCache.map(s => `<option value="${s.id}" ${s.id === current ? 'selected' : ''}>${esc(s.name)}</option>`).join('');
  } catch (e) {}
}

async function loadOrders() {
  const el = document.getElementById('ordersTable');
  el.innerHTML = '<div class="card-body"><span class="spinner"></span> Loading…</div>';

  try {
    const params = new URLSearchParams();
    const saleId = document.getElementById('orderSaleFilter').value;
    const status = document.getElementById('orderStatusFilter').value;
    const branch = document.getElementById('orderBranchFilter').value;

    if (saleId) params.set('sale_id', saleId);
    if (status) params.set('status', status);
    if (branch) params.set('branch', branch);

    const orders = await api(`/api/admin/orders?${params.toString()}`);
    renderOrders(orders);
  } catch (e) {
    el.innerHTML = `<div class="card-body" style="color:var(--danger)">${esc(e.message)}</div>`;
  }
}

function renderOrders(orders) {
  const el = document.getElementById('ordersTable');

  if (!orders.length) {
    el.innerHTML = '<div class="empty-state"><div class="icon">&#x1f4cb;</div><h3>No orders found</h3><p>Adjust filters or wait for customer orders.</p></div>';
    return;
  }

  el.innerHTML = `
    <table>
      <thead>
        <tr>
          <th>Order</th>
          <th>Shop</th>
          <th>Email</th>
          <th>Branch</th>
          <th>Items</th>
          <th>Total</th>
          <th>Status</th>
          <th>Date</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        ${orders.map(o => `
          <tr>
            <td class="mono" style="color:var(--info); cursor:pointer;" onclick="showOrderDetail('${o.id}')">${o.order_code}</td>
            <td>${esc(o.shop_name)}</td>
            <td class="text-dim text-xs">${esc(o.email)}</td>
            <td>${esc(o.branch)}</td>
            <td>${Array.isArray(o.items) ? o.items.length : '—'}</td>
            <td style="font-weight:600; color:var(--success)">$${parseFloat(o.total).toFixed(2)}</td>
            <td><span class="badge badge-${o.status}">${o.status}</span></td>
            <td class="text-dim text-xs">${formatDate(o.created_at)}</td>
            <td>
              <select class="btn-sm" onchange="updateOrderStatus('${o.id}', this.value)" style="background:var(--bg-input); color:var(--text); border:1px solid var(--border); border-radius:6px; padding:4px 8px; font-size:11px;">
                ${['pending','confirmed','shipped','delivered','cancelled'].map(s =>
                  `<option value="${s}" ${o.status === s ? 'selected' : ''}>${s}</option>`
                ).join('')}
              </select>
            </td>
          </tr>
        `).join('')}
      </tbody>
    </table>
  `;
}

async function updateOrderStatus(orderId, status) {
  try {
    await api(`/api/admin/orders/${orderId}`, { method: 'PATCH', body: { status } });
  } catch (e) {
    alert('Failed: ' + e.message);
    loadOrders();
  }
}

async function showOrderDetail(orderId) {
  try {
    const orders = await api('/api/admin/orders');
    const order = orders.find(o => o.id === orderId);
    if (!order) return;

    const items = Array.isArray(order.items) ? order.items : [];

    document.getElementById('modalContainer').innerHTML = `
      <div class="modal-backdrop" onclick="closeModal(event)">
        <div class="modal" onclick="event.stopPropagation()" style="max-width:640px">
          <div class="modal-header">
            <h3>Order ${esc(order.order_code)}</h3>
            <button class="modal-close" onclick="closeModal()">&times;</button>
          </div>
          <div class="modal-body">
            <div class="detail-row"><span class="label">Shop Name</span><span>${esc(order.shop_name)}</span></div>
            <div class="detail-row"><span class="label">Email</span><span>${esc(order.email)}</span></div>
            <div class="detail-row"><span class="label">Branch</span><span>${esc(order.branch)}</span></div>
            <div class="detail-row"><span class="label">Status</span><span class="badge badge-${order.status}">${order.status}</span></div>
            <div class="detail-row"><span class="label">Date</span><span>${new Date(order.created_at).toLocaleString()}</span></div>

            <h4 style="margin: 20px 0 10px; font-size: 14px;">Items (${items.length})</h4>
            <table class="order-items-table">
              <thead>
                <tr>
                  <th>SKU</th>
                  <th>Product</th>
                  <th>Qty</th>
                  <th style="text-align:right">Price</th>
                  <th style="text-align:right">Subtotal</th>
                </tr>
              </thead>
              <tbody>
                ${items.map(item => `
                  <tr>
                    <td class="mono" style="color:var(--info)">${esc(item.sku)}</td>
                    <td>${esc(item.name)}</td>
                    <td>${item.quantity}</td>
                    <td style="text-align:right">$${parseFloat(item.salePrice).toFixed(2)}</td>
                    <td style="text-align:right; font-weight:600; color:var(--success)">$${(parseFloat(item.salePrice) * item.quantity).toFixed(2)}</td>
                  </tr>
                `).join('')}
              </tbody>
            </table>

            <div style="text-align:right; padding: 16px 0; font-size: 18px; font-weight: 700; color: var(--success);">
              Total: $${parseFloat(order.total).toFixed(2)}
            </div>
          </div>
        </div>
      </div>
    `;
  } catch (e) {
    alert('Failed to load order: ' + e.message);
  }
}

// ============================================
// ADMIN USERS
// ============================================
async function loadUsers() {
  const el = document.getElementById('usersTable');
  el.innerHTML = '<div class="card-body"><span class="spinner"></span> Loading…</div>';

  try {
    const users = await api('/api/admin/users');
    renderUsers(users);
  } catch (e) {
    el.innerHTML = `<div class="card-body" style="color:var(--danger)">${esc(e.message)}</div>`;
  }
}

function renderUsers(users) {
  const el = document.getElementById('usersTable');

  el.innerHTML = `
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Email</th>
          <th>Role</th>
          <th>Status</th>
          <th>Last Login</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        ${users.map(u => `
          <tr>
            <td style="font-weight:600">${esc(u.name)}</td>
            <td class="text-dim">${esc(u.email)}</td>
            <td><span class="badge badge-${u.role === 'super_admin' ? 'super' : 'admin'}">${u.role.replace('_', ' ')}</span></td>
            <td><span class="badge ${u.is_active ? 'badge-active' : 'badge-archived'}">${u.is_active ? 'active' : 'disabled'}</span></td>
            <td class="text-dim text-xs">${u.last_login ? formatDate(u.last_login) : 'Never'}</td>
            <td>
              ${u.id !== admin.id ? `
                <div class="flex gap-2">
                  <button class="btn btn-sm ${u.is_active ? 'btn-danger' : 'btn-success'}" onclick="toggleAdmin('${u.id}', ${!u.is_active})">
                    ${u.is_active ? 'Disable' : 'Enable'}
                  </button>
                </div>
              ` : '<span class="text-dim text-xs">You</span>'}
            </td>
          </tr>
        `).join('')}
      </tbody>
    </table>
  `;
}

async function toggleAdmin(id, activate) {
  try {
    await api(`/api/admin/users/${id}`, { method: 'PATCH', body: { is_active: activate } });
    loadUsers();
  } catch (e) {
    alert('Failed: ' + e.message);
  }
}

function openAddAdmin() {
  document.getElementById('modalContainer').innerHTML = `
    <div class="modal-backdrop" onclick="closeModal(event)">
      <div class="modal" onclick="event.stopPropagation()">
        <div class="modal-header">
          <h3>Add Admin User</h3>
          <button class="modal-close" onclick="closeModal()">&times;</button>
        </div>
        <div class="modal-body">
          <div id="addAdminError" class="error-msg"></div>
          <div class="form-group"><label>Full Name *</label><input type="text" id="newAdminName" placeholder="Name"></div>
          <div class="form-group"><label>Email *</label><input type="email" id="newAdminEmail" placeholder="email@chcpaint.com"></div>
          <div class="form-group"><label>Password *</label><input type="password" id="newAdminPassword" placeholder="Min 8 characters"></div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" onclick="closeModal()">Cancel</button>
          <button class="btn btn-primary" id="addAdminBtn" onclick="saveNewAdmin()">Create Admin</button>
        </div>
      </div>
    </div>
  `;
}

async function saveNewAdmin() {
  const btn = document.getElementById('addAdminBtn');
  const errEl = document.getElementById('addAdminError');

  const name = document.getElementById('newAdminName').value.trim();
  const email = document.getElementById('newAdminEmail').value.trim();
  const password = document.getElementById('newAdminPassword').value;

  if (!name || !email || !password) {
    errEl.textContent = 'All fields are required';
    errEl.classList.add('visible');
    return;
  }

  btn.disabled = true;
  btn.innerHTML = '<span class="spinner"></span>';
  errEl.classList.remove('visible');

  try {
    await api('/api/admin/auth/register', { method: 'POST', body: { name, email, password } });
    closeModal();
    loadUsers();
  } catch (e) {
    errEl.textContent = e.message;
    errEl.classList.add('visible');
    btn.disabled = false;
    btn.textContent = 'Create Admin';
  }
}

// ============================================
// HELPERS
// ============================================
function closeModal(event) {
  if (event && event.target !== event.currentTarget) return;
  document.getElementById('modalContainer').innerHTML = '';
}

function esc(str) {
  if (!str) return '';
  const div = document.createElement('div');
  div.textContent = str;
  return div.innerHTML;
}

function formatDate(dateStr) {
  if (!dateStr) return '—';
  const d = new Date(dateStr);
  return d.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
}

// ============================================
// INIT
// ============================================
initApp();
</script>
</body>
</html>
